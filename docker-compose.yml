services:
  # --- NGINX (Frontend Service) ---
  nginx:
    # This can remain a build context as it depends on the nginx.conf from the repo
    build:
      context: ./frontend
    # Or, for consistency, you can use the image you pushed
    # image: your-dockerhub-username/fastreact-frontend:latest
    ports:
      - "80:80" # Expose HTTP port to the world
    depends_on:
      - backend

  # --- FASTAPI (Backend Service) ---
  backend:
    # Use the image from Docker Hub instead of building on the server
    image: your-dockerhub-username/fastreact-backend:latest
    # Do NOT expose ports to the host. Nginx will proxy to it.
    volumes:
      # Mount the credentials file into the container (read-only)
      - ./google-credentials.json:/app/google-credentials.json:ro
    env_file:
      - ./.env.prod # Load production environment variables
    depends_on:
      - redis

  # --- REDIS (Message Broker) ---
  redis:
    image: "redis:7-alpine"
    # No ports exposed to the host, only accessible within the Docker network.

  # --- CELERY (Worker Service) ---
  worker:
    # Use the same backend image from Docker Hub
    image: your-dockerhub-username/fastreact-backend:latest
    command: ["celery", "-A", "celery_worker.celery_app", "worker", "--loglevel=info"]
    volumes:
      # Mount the credentials file into the container (read-only)
      - ./google-credentials.json:/app/google-credentials.json:ro
    env_file:
      - ./.env.prod
    depends_on:
      - redis
      - backend